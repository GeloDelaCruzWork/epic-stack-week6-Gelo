import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
	console.log('‚ïî' + '‚ïê'.repeat(90) + '‚ïó')
	console.log(
		'‚ïë' +
			' '.repeat(20) +
			'COMPLETE GOVERNMENT SCHEDULES SUMMARY REPORT' +
			' '.repeat(26) +
			'‚ïë',
	)
	console.log(
		'‚ïë' + ' '.repeat(31) + 'Pay Period: 2025-09.B' + ' '.repeat(38) + '‚ïë',
	)
	console.log(
		'‚ïë' + ' '.repeat(27) + 'September 16-30, 2025' + ' '.repeat(42) + '‚ïë',
	)
	console.log('‚ïö' + '‚ïê'.repeat(90) + '‚ïù')

	// Get pay period B
	const payPeriodB = await prisma.payPeriod.findFirst({
		where: { code: '2025-09.B' },
	})

	if (!payPeriodB) {
		console.error('Pay period 2025-09.B not found!')
		return
	}

	// Get all guards
	const guards = await prisma.guard.findMany({
		where: { status: 'ACTIVE' },
		orderBy: { employee_no: 'asc' },
	})

	console.log('\nüìä SCHEDULE STATUS OVERVIEW')
	console.log('‚îÅ'.repeat(92))

	// Check schedule existence for each type
	const sssSchedules = await prisma.guardSSSSchedule.count({
		where: { pay_period_id: payPeriodB.id },
	})

	const philHealthSchedules = await prisma.guardPhilHealthSchedule.count({
		where: { pay_period_id: payPeriodB.id },
	})

	const hdmfSchedules = await prisma.guardHDMFSchedule.count({
		where: { pay_period_id: payPeriodB.id },
	})

	const taxSchedules = await prisma.guardTaxSchedule.count({
		where: { pay_period_id: payPeriodB.id },
	})

	console.log(`Total Active Guards: ${guards.length}`)
	console.log(
		`‚îú‚îÄ SSS Schedules:        ${sssSchedules} / ${guards.length} ${sssSchedules === guards.length ? '‚úÖ' : '‚ö†Ô∏è'}`,
	)
	console.log(
		`‚îú‚îÄ PhilHealth Schedules: ${philHealthSchedules} / ${guards.length} ${philHealthSchedules === guards.length ? '‚úÖ' : '‚ö†Ô∏è'}`,
	)
	console.log(
		`‚îú‚îÄ HDMF Schedules:       ${hdmfSchedules} / ${guards.length} ${hdmfSchedules === guards.length ? '‚ö†Ô∏è (Partial)' : '‚ö†Ô∏è'}`,
	)
	console.log(
		`‚îî‚îÄ Tax Schedules:        ${taxSchedules} / ${guards.length} ${taxSchedules === guards.length ? '‚úÖ' : '‚ö†Ô∏è'}`,
	)

	console.log('\nüìã DETAILED SCHEDULE BREAKDOWN BY GUARD')
	console.log('‚îÅ'.repeat(92))

	for (const guard of guards) {
		console.log(
			`\n${guard.employee_no} - ${guard.last_name}, ${guard.first_name}`,
		)
		console.log('‚îÄ'.repeat(50))

		// SSS Schedule
		const guardSSS = await prisma.guardSSS.findFirst({
			where: { guard_id: guard.id },
		})

		if (guardSSS) {
			const sssSchedule = await prisma.guardSSSSchedule.findFirst({
				where: {
					guard_sss_id: guardSSS.id,
					pay_period_id: payPeriodB.id,
				},
			})

			if (sssSchedule) {
				console.log(
					`  SSS:        EE: ‚Ç±${Number(sssSchedule.ee_amount).toFixed(2).padStart(10)} | ER: ‚Ç±${Number(sssSchedule.er_amount).toFixed(2).padStart(10)} | Status: ${sssSchedule.status}`,
				)
			} else {
				console.log(`  SSS:        ‚ùå No schedule found`)
			}
		} else {
			console.log(`  SSS:        ‚ùå Not registered`)
		}

		// PhilHealth Schedule
		const guardPH = await prisma.guardPhilHealth.findFirst({
			where: { guard_id: guard.id },
		})

		if (guardPH) {
			const phSchedule = await prisma.guardPhilHealthSchedule.findFirst({
				where: {
					guard_philhealth_id: guardPH.id,
					pay_period_id: payPeriodB.id,
				},
			})

			if (phSchedule) {
				console.log(
					`  PhilHealth: EE: ‚Ç±${Number(phSchedule.ee_amount).toFixed(2).padStart(10)} | ER: ‚Ç±${Number(phSchedule.er_amount).toFixed(2).padStart(10)} | Status: ${phSchedule.status}`,
				)
			} else {
				console.log(`  PhilHealth: ‚ùå No schedule found`)
			}
		} else {
			console.log(`  PhilHealth: ‚ùå Not registered`)
		}

		// HDMF Schedule
		const hdmfSchedule = await prisma.guardHDMFSchedule.findFirst({
			where: {
				guard_id: guard.id,
				pay_period_id: payPeriodB.id,
			},
		})

		if (hdmfSchedule) {
			console.log(
				`  HDMF:       EE: ‚Ç±${Number(hdmfSchedule.ee_amount).toFixed(2).padStart(10)} | ER: ‚Ç±${Number(hdmfSchedule.er_amount).toFixed(2).padStart(10)} | Status: ${hdmfSchedule.status}`,
			)
		} else {
			console.log(`  HDMF:       ‚ùå No schedule found`)
		}

		// Tax Schedule
		const taxSchedule = await prisma.guardTaxSchedule.findFirst({
			where: {
				guard_id: guard.id,
				pay_period_id: payPeriodB.id,
			},
		})

		if (taxSchedule) {
			console.log(
				`  Tax:        Withholding: ‚Ç±${Number(taxSchedule.total_withholding).toFixed(2).padStart(10)} | Bracket: ${taxSchedule.tax_bracket} | Status: ${taxSchedule.status}`,
			)
			console.log(
				`              Taxable Income: ‚Ç±${Number(taxSchedule.taxable_income).toFixed(2)} (Gross: ‚Ç±${Number(taxSchedule.gross_income).toFixed(2)})`,
			)
		} else {
			console.log(`  Tax:        ‚ùå No schedule found`)
		}
	}

	console.log('\nüí∞ FINANCIAL SUMMARY')
	console.log('‚îÅ'.repeat(92))

	// Calculate totals
	const sssTotal = await prisma.guardSSSSchedule.aggregate({
		where: { pay_period_id: payPeriodB.id },
		_sum: { ee_amount: true, er_amount: true },
	})

	const phTotal = await prisma.guardPhilHealthSchedule.aggregate({
		where: { pay_period_id: payPeriodB.id },
		_sum: { ee_amount: true, er_amount: true },
	})

	const hdmfTotal = await prisma.guardHDMFSchedule.aggregate({
		where: { pay_period_id: payPeriodB.id },
		_sum: { ee_amount: true, er_amount: true },
	})

	const taxTotal = await prisma.guardTaxSchedule.aggregate({
		where: { pay_period_id: payPeriodB.id },
		_sum: { total_withholding: true, gross_income: true, taxable_income: true },
	})

	const sssEE = Number(sssTotal._sum.ee_amount || 0)
	const sssER = Number(sssTotal._sum.er_amount || 0)
	const phEE = Number(phTotal._sum.ee_amount || 0)
	const phER = Number(phTotal._sum.er_amount || 0)
	const hdmfEE = Number(hdmfTotal._sum.ee_amount || 0)
	const hdmfER = Number(hdmfTotal._sum.er_amount || 0)
	const taxWithholding = Number(taxTotal._sum.total_withholding || 0)
	const totalGross = Number(taxTotal._sum.gross_income || 0)

	const totalEEDeductions = sssEE + phEE + hdmfEE
	const totalERContributions = sssER + phER + hdmfER
	const totalWithDeductions = totalEEDeductions + taxWithholding

	console.log('Employee Deductions:')
	console.log(`  SSS:              ‚Ç±${sssEE.toFixed(2).padStart(12)}`)
	console.log(`  PhilHealth:       ‚Ç±${phEE.toFixed(2).padStart(12)}`)
	console.log(`  HDMF/Pag-IBIG:    ‚Ç±${hdmfEE.toFixed(2).padStart(12)}`)
	console.log(`  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`)
	console.log(
		`  Subtotal:         ‚Ç±${totalEEDeductions.toFixed(2).padStart(12)}`,
	)
	console.log(`  Withholding Tax:  ‚Ç±${taxWithholding.toFixed(2).padStart(12)}`)
	console.log(`  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`)
	console.log(
		`  TOTAL DEDUCTIONS: ‚Ç±${totalWithDeductions.toFixed(2).padStart(12)}`,
	)

	console.log('\nEmployer Contributions:')
	console.log(`  SSS:              ‚Ç±${sssER.toFixed(2).padStart(12)}`)
	console.log(`  PhilHealth:       ‚Ç±${phER.toFixed(2).padStart(12)}`)
	console.log(`  HDMF/Pag-IBIG:    ‚Ç±${hdmfER.toFixed(2).padStart(12)}`)
	console.log(`  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`)
	console.log(
		`  TOTAL:            ‚Ç±${totalERContributions.toFixed(2).padStart(12)}`,
	)

	console.log('\nPayroll Summary:')
	console.log(`  Gross Salaries:   ‚Ç±${totalGross.toFixed(2).padStart(12)}`)
	console.log(
		`  Employee Deduct:  ‚Ç±${totalWithDeductions.toFixed(2).padStart(12)}`,
	)
	console.log(
		`  Net Pay:          ‚Ç±${(totalGross - totalWithDeductions).toFixed(2).padStart(12)}`,
	)
	console.log(
		`  Employer Cost:    ‚Ç±${totalERContributions.toFixed(2).padStart(12)}`,
	)
	console.log(`  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`)
	console.log(
		`  TOTAL COST:       ‚Ç±${(totalGross + totalERContributions).toFixed(2).padStart(12)}`,
	)

	// Check for missing schedules
	console.log('\n‚ö†Ô∏è  ALERTS & REMINDERS')
	console.log('‚îÅ'.repeat(92))

	const missingSchedules = []

	for (const guard of guards) {
		const missing = []

		// Check SSS
		const guardSSS = await prisma.guardSSS.findFirst({
			where: { guard_id: guard.id },
		})
		if (guardSSS) {
			const sssSchedule = await prisma.guardSSSSchedule.findFirst({
				where: { guard_sss_id: guardSSS.id, pay_period_id: payPeriodB.id },
			})
			if (!sssSchedule) missing.push('SSS')
		} else {
			missing.push('SSS Registration')
		}

		// Check PhilHealth
		const guardPH = await prisma.guardPhilHealth.findFirst({
			where: { guard_id: guard.id },
		})
		if (guardPH) {
			const phSchedule = await prisma.guardPhilHealthSchedule.findFirst({
				where: {
					guard_philhealth_id: guardPH.id,
					pay_period_id: payPeriodB.id,
				},
			})
			if (!phSchedule) missing.push('PhilHealth')
		} else {
			missing.push('PhilHealth Registration')
		}

		// Check HDMF
		const hdmfSchedule = await prisma.guardHDMFSchedule.findFirst({
			where: { guard_id: guard.id, pay_period_id: payPeriodB.id },
		})
		if (!hdmfSchedule) missing.push('HDMF')

		// Check Tax
		const taxSchedule = await prisma.guardTaxSchedule.findFirst({
			where: { guard_id: guard.id, pay_period_id: payPeriodB.id },
		})
		if (!taxSchedule) missing.push('Tax')

		if (missing.length > 0) {
			missingSchedules.push({
				guard: `${guard.employee_no} - ${guard.last_name}`,
				missing,
			})
		}
	}

	if (missingSchedules.length > 0) {
		console.log('Missing Schedules:')
		for (const item of missingSchedules) {
			console.log(`  ${item.guard}: ${item.missing.join(', ')}`)
		}
	} else {
		console.log('‚úÖ All required schedules are complete!')
	}

	console.log('\nüìÖ REMITTANCE DEADLINES:')
	console.log('‚Ä¢ SSS & PhilHealth: Last day of the following month')
	console.log('‚Ä¢ HDMF/Pag-IBIG: 10th of the following month')
	console.log('‚Ä¢ BIR (1601-C): 10th of the following month')

	console.log('\n' + '‚ïê'.repeat(92))
	console.log('Report Generated:', new Date().toLocaleString())
	console.log('System: Philippine Payroll Compliance System 2025')
	console.log('‚ïê'.repeat(92))
}

main()
	.catch((e) => {
		console.error('Error:', e)
		process.exit(1)
	})
	.finally(async () => {
		await prisma.$disconnect()
	})
